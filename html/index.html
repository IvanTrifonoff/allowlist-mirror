<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhiteList Scanner</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .box { border: 1px solid #333; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: #222; }
        button { cursor: pointer; padding: 10px 20px; background: #004400; color: #fff; border: 1px solid #0f0; font-family: monospace; margin-right: 10px; font-size: 14px; }
        button:hover { background: #006600; }
        button.debug { background: #444; border-color: #888; color: #ddd; }
        select { padding: 10px; background: #000; color: #fff; border: 1px solid #333; margin-bottom: 10px; width: 100%; font-size: 14px; }
        #logs { white-space: pre-wrap; word-wrap: break-word; font-size: 12px; color: #aaa; max-height: 400px; overflow-y: auto; background: #000; padding: 10px; border: 1px solid #333; }
    </style>
</head>
<body>

    <h1>üì° Allowlist Scanner v1.3</h1>

    <div class="box">
        <h3>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞</h3>
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Ä–µ–≥–∏–æ–Ω:</label>
        <select id="region-select">
            <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>
            <option value="RU-MOW">–ú–æ—Å–∫–≤–∞</option>
            <option value="RU-SPE">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
            <option value="RU-AD">–ê–¥—ã–≥–µ—è</option>
            <option value="RU-AL">–ê–ª—Ç–∞–π (–†–µ—Å–ø—É–±–ª–∏–∫–∞)</option>
            <option value="RU-ALT">–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-AMU">–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ARK">–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-AST">–ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-BA">–ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω</option>
            <option value="RU-BEL">–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-BRY">–ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-BU">–ë—É—Ä—è—Ç–∏—è</option>
            <option value="RU-VLA">–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-VGG">–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-VLG">–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-VOR">–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-DA">–î–∞–≥–µ—Å—Ç–∞–Ω</option>
            <option value="RU-JE">–ï–≤—Ä–µ–π—Å–∫–∞—è –ê–û</option>
            <option value="RU-ZAB">–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-IVA">–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-IN">–ò–Ω–≥—É—à–µ—Ç–∏—è</option>
            <option value="RU-IRK">–ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KB">–ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä–∏—è</option>
            <option value="RU-KGD">–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KL">–ö–∞–ª–º—ã–∫–∏—è</option>
            <option value="RU-KLU">–ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KAM">–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-KC">–ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å–∏—è</option>
            <option value="RU-KR">–ö–∞—Ä–µ–ª–∏—è</option>
            <option value="RU-KEM">–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KIR">–ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KO">–ö–æ–º–∏</option>
            <option value="RU-KOS">–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KDA">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-KYA">–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-CRM">–ö—Ä—ã–º</option>
            <option value="RU-KGN">–ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KRS">–ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-LEN">–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-LIP">–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-MAG">–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ME">–ú–∞—Ä–∏–π –≠–ª</option>
            <option value="RU-MO">–ú–æ—Ä–¥–æ–≤–∏—è</option>
            <option value="RU-MOS">–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-MUR">–ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-NEN">–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û</option>
            <option value="RU-NIZ">–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-NGR">–ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-NVS">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-OMS">–û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ORE">–û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ORL">–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-PNZ">–ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-PER">–ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-PRI">–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-PSK">–ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ROS">–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-RYA">–†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SAM">–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SAR">–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SA">–°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)</option>
            <option value="RU-SAK">–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SVE">–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SEV">–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å</option>
            <option value="RU-SE">–°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è</option>
            <option value="RU-SMO">–°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-STA">–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-TAM">–¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-TA">–¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω</option>
            <option value="RU-TVE">–¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-TOM">–¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-TUL">–¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-TY">–¢—ã–≤–∞</option>
            <option value="RU-TYU">–¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-UD">–£–¥–º—É—Ä—Ç–∏—è</option>
            <option value="RU-ULY">–£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KHA">–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-KK">–•–∞–∫–∞—Å–∏—è</option>
            <option value="RU-KHM">–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û</option>
            <option value="RU-CHE">–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-CE">–ß–µ—á–Ω—è</option>
            <option value="RU-CU">–ß—É–≤–∞—à–∏—è</option>
            <option value="RU-CHU">–ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û</option>
            <option value="RU-YAM">–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û</option>
            <option value="RU-YAR">–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="OTHER">-- –î—Ä—É–≥–æ–µ / VPN --</option>
        </select>
    </div>

    <div class="box">
        <h3>2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <button onclick="startTest('express')">üöÄ –≠–∫—Å–ø—Ä–µ—Å—Å –¢–µ—Å—Ç</button>
        <button onclick="startTest('full')">üì° –ü–æ–ª–Ω—ã–π –°–∫–∞–Ω</button>
        <hr style="border-color: #333; margin: 15px 0;">
        <button class="debug" onclick="runSelfTest()">üõ† –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (Debug)</button>
    </div>

    <div class="box">
        <h3>3. –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <div id="logs">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞...</div>
    </div>

<script>
    const API_BASE = '/api'; 

    function log(msg, type='') {
        const el = document.getElementById('logs');
        let color = '#aaa';
        if (type === 'ok') color = '#0f0';
        if (type === 'err') color = '#f00';
        if (type === 'warn') color = '#ff0';
        if (type === 'info') color = '#0ff';
        
        const span = `<div style="color:${color}; margin-bottom: 4px;">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        el.innerHTML += span;
        el.scrollTop = el.scrollHeight;
    }

    // --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ---
    async function startTest(mode) {
        const region = document.getElementById('region-select').value;
        if (!region) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Ä–µ–≥–∏–æ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞!"); return; }

        log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (${mode})...`, 'info');

        // –≠–¢–ê–ü 0: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ö–∞–Ω–∞—Ä–µ–π–∫–∞)
        log("–ê–Ω–∞–ª–∏–∑ —Å–µ—Ç–µ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...", 'warn');
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Å—É—Ä—Å, –∫–æ—Ç–æ—Ä—ã–π –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù
        const canary = await probeIP('www.google.com'); 
        
        if (canary.ok) {
            // Google –¥–æ—Å—Ç—É–ø–µ–Ω -> –û–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
            log("‚ö†Ô∏è –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.", 'warn');
            log("–í–∞—à–µ —Ç–µ–∫—É—â–µ–µ —Å–µ—Ç–µ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.", 'info');
            log("–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.", 'info');
            return; // –ü–†–ï–†–´–í–ê–ï–ú –í–´–ü–û–õ–ù–ï–ù–ò–ï
        } else {
            log("‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.", 'ok');
            log("–ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...", 'ok');
        }
        
        try {
            // –≠–¢–ê–ü 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á
            const response = await fetch(`${API_BASE}/tasks?mode=${mode}`);
            if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ${response.status}`);
            const subnets = await response.json();
            
            if (!subnets || subnets.length === 0) {
                log("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –¥–ª—è –≤–∞—à–µ–≥–æ —É–∑–ª–∞.", 'err');
                return;
            }

            log(`–ü–æ–ª—É—á–µ–Ω–æ —Ü–µ–ª–µ–π: ${subnets.length}`, 'info');
            
            const results = [];
            
            // –≠–¢–ê–ü 2: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            for (let i = 0; i < subnets.length; i++) {
                const sub = subnets[i];
                log(`[${i+1}/${subnets.length}] –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–∑–ª–∞ #${sub.id}...`);
                
                if (sub.target_ip_1) {
                    const res = await probeIP(sub.target_ip_1);
                    results.push(makeResult(sub.id, sub.target_ip_1, res));
                }
                if (sub.target_ip_2 && sub.target_ip_2 !== sub.target_ip_1) {
                    const res = await probeIP(sub.target_ip_2);
                    results.push(makeResult(sub.id, sub.target_ip_2, res));
                }
            }
            
            // –≠–¢–ê–ü 3: –û—Ç–ø—Ä–∞–≤–∫–∞
            log(`–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...`);
            await fetch(`${API_BASE}/submit`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ manual_region: region, results: results })
            });
            
            log("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω—ã. –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–º–æ—â—å!", 'ok');
            
        } catch (e) {
            log(`–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${e.message}`, 'err');
        }
    }

    function makeResult(sid, ip, res) {
        return { subnet_id: sid, ip_tested: ip, is_accessible: res.ok, latency_ms: res.time };
    }

    // --- –§–£–ù–ö–¶–ò–Ø –ü–†–û–ó–í–û–ù–ê (Probe) ---
    async function probeIP(ip) {
        const start = Date.now();
        const timeout = 5000; 
        
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            const target = ip.includes(':') ? `https://[${ip}]` : `https://${ip}`;

            await fetch(target, { 
                mode: 'no-cors', 
                cache: 'no-store',
                signal: controller.signal 
            });
            
            clearTimeout(id);
            return { ok: true, time: Date.now() - start }; 
            
        } catch (err) {
            const time = Date.now() - start;
            if (err.name === 'AbortError') return { ok: false, time: time };
            if (time < 2000) return { ok: true, time: time };
            return { ok: false, time: time };
        }
    }

    // --- –†–ï–ñ–ò–ú –û–¢–õ–ê–î–ö–ò ---
    async function runSelfTest() {
        log("=== –ó–ê–ü–£–°–ö –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===", 'warn');
        
        log("1. –ü—Ä–æ–≤–µ—Ä–∫–∞ API...");
        try {
            const t1 = Date.now();
            const res = await fetch(`${API_BASE}/tasks?mode=express`);
            if (res.ok) log(`   OK! (${Date.now()-t1}–º—Å)`, 'ok');
            else log(`   –û—à–∏–±–∫–∞ HTTP ${res.status}`, 'err');
        } catch (e) {
            log(`   –ü–†–û–í–ê–õ: –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.`, 'err');
        }

        log("2. –¢–µ—Å—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–≥–æ —É–∑–ª–∞ (Yandex)...");
        const resYa = await probeIP('77.88.8.8');
        if (resYa.ok) log(`   OK! (${resYa.time}–º—Å).`, 'ok');
        else log(`   –û–®–ò–ë–ö–ê: –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.`, 'err');

        log("3. –¢–µ—Å—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–Ω—Ç—É—Ä–∞...");
        const resG = await probeIP('www.google.com');
        if (resG.ok) {
            log(`   –î–æ—Å—Ç—É–ø –µ—Å—Ç—å (${resG.time}–º—Å). (–û–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)`, 'warn');
        } else {
            log(`   –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω. (–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫)`, 'ok');
        }
        log("=== –ö–û–ù–ï–¶ ===");
    }
</script>
</body>
</html>
