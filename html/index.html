<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhiteList Scanner v2.1</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .box { border: 1px solid #333; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: #222; }
        button { cursor: pointer; padding: 10px 20px; background: #004400; color: #fff; border: 1px solid #0f0; font-family: monospace; margin-right: 10px; font-size: 14px; }
        button:hover { background: #006600; }
        button:disabled { background: #222; border-color: #444; color: #666; cursor: not-allowed; }
        button.stop { background: #660000; border-color: #f00; display: none; }
        button.debug { background: #444; border-color: #888; color: #ddd; }
        select { padding: 10px; background: #000; color: #fff; border: 1px solid #333; margin-bottom: 10px; width: 100%; font-size: 14px; }
        #logs { white-space: pre-wrap; word-wrap: break-word; font-size: 12px; color: #aaa; max-height: 400px; overflow-y: auto; background: #000; padding: 10px; border: 1px solid #333; }
        #queue-status { float: right; color: #ff0; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üì° Allowlist Scanner v2.1 <span id="queue-status"></span></h1>

    <div class="box">
        <h3>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞</h3>
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Ä–µ–≥–∏–æ–Ω:</label>
        <select id="region-select">
            <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>
            <option value="RU-MOW">–ú–æ—Å–∫–≤–∞</option>
            <option value="RU-SPE">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
            <option value="RU-AD">–ê–¥—ã–≥–µ—è</option>
            <option value="RU-AL">–ê–ª—Ç–∞–π (–†–µ—Å–ø—É–±–ª–∏–∫–∞)</option>
            <option value="RU-ALT">–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-AMU">–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ARK">–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-AST">–ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-BA">–ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω</option>
            <option value="RU-BEL">–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-BRY">–ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-BU">–ë—É—Ä—è—Ç–∏—è</option>
            <option value="RU-VLA">–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-VGG">–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-VLG">–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-VOR">–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-DA">–î–∞–≥–µ—Å—Ç–∞–Ω</option>
            <option value="RU-JE">–ï–≤—Ä–µ–π—Å–∫–∞—è –ê–û</option>
            <option value="RU-ZAB">–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-IVA">–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-IN">–ò–Ω–≥—É—à–µ—Ç–∏—è</option>
            <option value="RU-IRK">–ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KB">–ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä–∏—è</option>
            <option value="RU-KGD">–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KL">–ö–∞–ª–º—ã–∫–∏—è</option>
            <option value="RU-KLU">–ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KAM">–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-KC">–ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å–∏—è</option>
            <option value="RU-KR">–ö–∞—Ä–µ–ª–∏—è</option>
            <option value="RU-KEM">–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KIR">–ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KO">–ö–æ–º–∏</option>
            <option value="RU-KOS">–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KDA">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-KYA">–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-CRM">–ö—Ä—ã–º</option>
            <option value="RU-KGN">–ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KRS">–ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-LEN">–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-LIP">–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-MAG">–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ME">–ú–∞—Ä–∏–π –≠–ª</option>
            <option value="RU-MO">–ú–æ—Ä–¥–æ–≤–∏—è</option>
            <option value="RU-MOS">–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-MUR">–ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-NEN">–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û</option>
            <option value="RU-NIZ">–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-NGR">–ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-NVS">–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-OMS">–û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ORE">–û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ORL">–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-PNZ">–ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-PER">–ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-PRI">–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-PSK">–ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-ROS">–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-RYA">–†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SAM">–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SAR">–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SA">–°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)</option>
            <option value="RU-SAK">–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SVE">–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-SEV">–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å</option>
            <option value="RU-SE">–°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è</option>
            <option value="RU-SMO">–°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-STA">–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-TAM">–¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-TA">–¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω</option>
            <option value="RU-TVE">–¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-TOM">–¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-TUL">–¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-TY">–¢—ã–≤–∞</option>
            <option value="RU-TYU">–¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-UD">–£–¥–º—É—Ä—Ç–∏—è</option>
            <option value="RU-ULY">–£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-KHA">–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π</option>
            <option value="RU-KK">–•–∞–∫–∞—Å–∏—è</option>
            <option value="RU-KHM">–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û</option>
            <option value="RU-CHE">–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="RU-CE">–ß–µ—á–Ω—è</option>
            <option value="RU-CU">–ß—É–≤–∞—à–∏—è</option>
            <option value="RU-CHU">–ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û</option>
            <option value="RU-YAM">–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û</option>
            <option value="RU-YAR">–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
            <option value="OTHER">-- –î—Ä—É–≥–æ–µ / VPN --</option>
        </select>
    </div>

    <div class="box">
        <h3>2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <button id="btn-express" onclick="startTest('express')">üöÄ –≠–∫—Å–ø—Ä–µ—Å—Å –¢–µ—Å—Ç</button>
        <button id="btn-full" onclick="startTest('full')">üì° –ü–æ–ª–Ω—ã–π –°–∫–∞–Ω (–¶–∏–∫–ª)</button>
        <button id="btn-stop" class="stop" onclick="stopTest()">üõë –û–°–¢–ê–ù–û–í–ò–¢–¨</button>
        <hr style="border-color: #333; margin: 15px 0;">
        <button class="debug" onclick="runSelfTest()">üõ† –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (Debug)</button>
    </div>

    <div class="box">
        <h3>3. –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <div id="logs">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞...</div>
    </div>

    <div class="box" style="border-color: #004400;">
        <h3>üìä –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div id="stats-box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

<script>
    const API_BASE = '/api'; 
    let isScanning = false;
    let stopRequested = false;

    // --- –ö–õ–ê–°–° –û–¢–ü–†–ê–í–ö–ò –†–ï–ó–£–õ–¨–¢–ê–¢–û–í (–û—á–µ—Ä–µ–¥—å + Retry) ---
    class ResultSender {
        constructor() {
            this.queue = [];
            this.isSending = false;
            this.retryLimit = 10; 
        }

        add(data) {
            this.queue.push({ data: data, attempts: 0 });
            this.updateStatus();
            this.process();
        }

        updateStatus() {
            const el = document.getElementById('queue-status');
            if (this.queue.length > 0) {
                el.innerText = `[–û—á–µ—Ä–µ–¥—å: ${this.queue.length}]`;
            } else {
                el.innerText = "";
            }
        }

        async process() {
            if (this.isSending || this.queue.length === 0) return;
            this.isSending = true;

            const item = this.queue[0];
            const delay = Math.min(1000 * Math.pow(1.5, item.attempts), 30000); 

            try {
                if (item.attempts > 0) {
                    await new Promise(r => setTimeout(r, delay));
                    log(`üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ (–ø–æ–ø—ã—Ç–∫–∞ ${item.attempts + 1})...`, 'warn');
                }

                const response = await fetch(`${API_BASE}/submit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item.data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                log(`‚úÖ –ü–∞–∫–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.`, 'ok');
                this.queue.shift(); 
                loadStats();

            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${e.message}. –ü–æ–≤—Ç–æ—Ä–∏–º —á–µ—Ä–µ–∑ ${Math.ceil(delay/1000)}—Å`, 'err');
                item.attempts++;
                if (item.attempts >= this.retryLimit) {
                    log(`üíÄ –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞–∫–µ—Ç –ø–æ—Å–ª–µ ${this.retryLimit} –ø–æ–ø—ã—Ç–æ–∫. –î–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã.`, 'err');
                    this.queue.shift();
                }
            } finally {
                this.isSending = false;
                this.updateStatus();
                if (this.queue.length > 0) this.process();
            }
        }
    }

    const sender = new ResultSender();

    function log(msg, type='') {
        const el = document.getElementById('logs');
        let color = '#aaa';
        if (type === 'ok') color = '#0f0';
        if (type === 'err') color = '#f00';
        if (type === 'warn') color = '#ff0';
        if (type === 'info') color = '#0ff';
        
        const span = `<div style="color:${color}; margin-bottom: 4px;">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        el.innerHTML += span;
        el.scrollTop = el.scrollHeight;
    }

    window.onload = loadStats;

    async function loadStats() {
        try {
            const res = await fetch(`${API_BASE}/stats`);
            if (!res.ok) throw new Error("Stats error");
            const data = await res.json();
            
            let html = `
                <p>–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥—Å–µ—Ç–µ–π: <b>${data.total_active_subnets}</b></p>
                <p>–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –ø—Ä–æ–≤–µ—Ä–æ–∫: <b>${data.total_checks_performed}</b></p>
                <p style="color: #0f0">–ù–∞–π–¥–µ–Ω–Ω—ã—Ö "–ë–µ–ª—ã—Ö" –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤: <b>${data.found_accessible_subnets}</b></p>
                <hr style="border-color: #333">
                <p>–õ–∏–¥–µ—Ä—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:</p>
                <ul>
            `;
            
            data.top_providers.forEach(p => {
                html += `<li>${p.provider_name}: ${p.wins} —É—Å–ø–µ—Ö–æ–≤</li>`;
            });
            html += `</ul>`;
            
            document.getElementById('stats-box').innerHTML = html;
        } catch (e) {
            document.getElementById('stats-box').innerText = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–æ—à–∏–±–∫–∞ —Å–≤—è–∑–∏).";
        }
    }

    function toggleUI(scanning) {
        isScanning = scanning;
        document.getElementById('btn-express').disabled = scanning;
        document.getElementById('btn-full').disabled = scanning;
        document.getElementById('btn-stop').style.display = scanning ? 'inline-block' : 'none';
        document.getElementById('region-select').disabled = scanning;
    }

    function stopTest() {
        if (isScanning) {
            stopRequested = true;
            log("üõë –ó–∞–ø—Ä–æ—à–µ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞... –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞–∫–µ—Ç...", 'warn');
        }
    }

    // --- –ö–ê–ù–ê–†–ï–ô–ö–ê (–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ RU vs WORLD) ---
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–∞—Ä—Ç–∏–Ω–æ–∫, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    
    async function checkEnvironment() {
        log("üîç –ê–Ω–∞–ª–∏–∑ —Å–µ—Ç–µ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏)...", 'warn');
        
        const TIMEOUT = 5000; // 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–ø—ã—Ç–∫—É

        // 1. –≠—Ç–∞–ª–æ–Ω—ã (RU) - –¥–æ–ª–∂–Ω—ã –ª–µ—Ç–∞—Ç—å
        const benchmarks = [
            'https://yastatic.net/s3/home/logos/share/share-logo_ru.png', // Yandex
            'https://vk.com/images/svg_icons/ic_head_logo.svg' // VK
        ];

        // 2. –¢–µ—Å—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ (–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏–ª–∏ –∑–∞–º–µ–¥–ª–µ–Ω—ã)
        const targets = [
            'https://static.xx.fbcdn.net/rsrc.php/y8/r/dF5SId3UHWd.svg', // Facebook CDN
            'https://abs.twimg.com/responsive-web/client-web/icon-default.11666600.png' // Twitter
        ];

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–º–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ (Image Load)
        const measure = (url) => new Promise(resolve => {
            const start = Date.now();
            const img = new Image();
            let done = false;
            // –î–æ–±–∞–≤–ª—è–µ–º timestamp —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–µ—à–∞ –±—Ä–∞—É–∑–µ—Ä–∞
            const cacheBuster = (url.includes('?') ? '&' : '?') + 't=' + Date.now();

            const finish = (status) => {
                if(done) return;
                done = true;
                const duration = Date.now() - start;
                resolve({ time: duration, status: status });
            };

            img.onload = () => finish('ok');
            img.onerror = () => finish('err'); // –û—à–∏–±–∫–∞ (RST, DNS error, Block)
            
            // –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ - —Å—á–∏—Ç–∞–µ–º —Ç–∞–π–º-–∞—É—Ç–æ–º (Throttling)
            setTimeout(() => finish('timeout'), TIMEOUT);
            
            img.src = url + cacheBuster;
        });

        // --- –®–ê–ì 1: RU –°–µ–≥–º–µ–Ω—Ç ---
        log("   ‚è≥ –¢–µ—Å—Ç RU —Å–µ–≥–º–µ–Ω—Ç–∞ (Yandex/VK)...");
        let ruTimes = [];
        for (let url of benchmarks) {
            const res = await measure(url);
            if (res.status === 'ok') ruTimes.push(res.time);
        }
        
        if (ruTimes.length === 0) {
            log("   ‚ö†Ô∏è –û—à–∏–±–∫–∞: RU —Ä–µ—Å—É—Ä—Å—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞?", 'err');
            return false; // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ "–ø–æ–¥—Ö–æ–¥–∏—Ç" (–º—ã –Ω–µ –≤ —á–∏—Å—Ç–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ), –Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ —Å–º–æ–∂–µ—Ç.
                          // –ù–æ –ø—É—Å—Ç—å –ª—É—á—à–µ —Å–∫–∞–Ω–µ—Ä –ø–æ–ø—Ä–æ–±—É–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∏ —É–ø–∞–¥–µ—Ç, —á–µ–º –º–æ–ª—á–∞ –≤—ã–π–¥–µ—Ç.
        }
        
        const avgRu = ruTimes.reduce((a,b)=>a+b,0) / ruTimes.length;
        log(`   ‚úÖ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è RU: ${avgRu.toFixed(0)}–º—Å`, 'ok');


        // --- –®–ê–ì 2: –í–Ω–µ—à–Ω–∏–π –°–µ–≥–º–µ–Ω—Ç ---
        log("   ‚è≥ –¢–µ—Å—Ç –≤–Ω–µ—à–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (Meta/X)...");
        let worldTimes = [];
        let fails = 0;
        
        for (let url of targets) {
            const res = await measure(url);
            if (res.status === 'ok') {
                worldTimes.push(res.time);
                log(`      –†–µ—Å—É—Ä—Å –¥–æ—Å—Ç—É–ø–µ–Ω –∑–∞ ${res.time}–º—Å`);
            } else {
                fails++;
                log(`      –†–µ—Å—É—Ä—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (${res.status})`);
            }
        }

        // --- –õ–û–ì–ò–ö–ê –†–ï–®–ï–ù–ò–Ø ---
        
        // 1. –ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
        if (fails === targets.length) {
            log("   ‚õîÔ∏è –í–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.", 'warn');
            return false; // IS_NORMAL = false -> –ó–ê–ü–£–°–ö–ê–ï–ú –°–ö–ê–ù
        }

        // 2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–µ–π (Throttling)
        const avgWorld = worldTimes.reduce((a,b)=>a+b,0) / worldTimes.length;
        log(`   ‚ö†Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è WORLD: ${avgWorld.toFixed(0)}–º—Å`, 'warn');

        const ratio = avgWorld / (avgRu + 1); // +1 –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ 0
        log(`   üìä –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–º–µ–¥–ª–µ–Ω–∏—è: x${ratio.toFixed(1)}`);

        // –ï—Å–ª–∏ –≤–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã –≤ 3 —Ä–∞–∑–∞ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ò–õ–ò –¥–æ–ª—å—à–µ 2 —Å–µ–∫—É–Ω–¥
        if (ratio > 3.0 || avgWorld > 2000) {
            log("   üêå –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ.", 'warn');
            return false; // IS_NORMAL = false -> –ó–ê–ü–£–°–ö–ê–ï–ú –°–ö–ê–ù
        }

        log("   üöÄ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –∏ —Å–≤–æ–±–æ–¥–Ω–æ. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.", 'ok');
        return true; // IS_NORMAL = true -> –ù–ï –ó–ê–ü–£–°–ö–ê–ï–ú
    }

    // --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ---
    async function startTest(mode) {
        const region = document.getElementById('region-select').value;
        if (!region) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Ä–µ–≥–∏–æ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞!"); return; }

        toggleUI(true);
        stopRequested = false;
        log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (${mode})...`, 'info');

        // –≠–¢–ê–ü 0: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Multi-target)
        log("–ê–Ω–∞–ª–∏–∑ —Å–µ—Ç–µ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...", 'warn');
        const isNormalInternet = await checkEnvironment();
        
        if (isNormalInternet) {
            log("‚ö†Ô∏è –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.", 'warn');
            log("–í–∞—à–µ —Ç–µ–∫—É—â–µ–µ —Å–µ—Ç–µ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º.", 'info');
            toggleUI(false);
            return; 
        } else {
            log("‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.", 'ok');
        }
        
        let batchCount = 0;
        const maxBatches = (mode === 'express') ? 5 : 20;

        while (!stopRequested && batchCount < maxBatches) {
            batchCount++;
            log(`=== –ü–∞–∫–µ—Ç #${batchCount} ===`, 'info');
            
            let minPriority = (mode === 'express') ? 10 : 1; 
            if (mode === 'full' && batchCount > 10) minPriority = 5;

            try {
                const response = await fetch(`${API_BASE}/tasks?mode=${mode}&min_priority=${minPriority}`);
                if (!response.ok) throw new Error(`API Tasks Error: ${response.status}`);
                const subnets = await response.json();
                
                if (!subnets || subnets.length === 0) {
                    log("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á. –û–∂–∏–¥–∞–Ω–∏–µ...", 'warn');
                    if (mode === 'express' && batchCount >= maxBatches) break;
                    if (mode === 'full' && batchCount >= maxBatches) break;
                    await new Promise(r => setTimeout(r, 5000));
                    continue;
                }

                log(`–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ${subnets.length} —Ü–µ–ª–µ–π...`);
                const results = [];
                
                for (let i = 0; i < subnets.length; i++) {
                    if (stopRequested) break;

                    const sub = subnets[i];
                    
                    if (sub.target_ip_1) {
                        const res = await probeIP(sub.target_ip_1);
                        results.push(makeResult(sub.id, sub.target_ip_1, res));
                    }
                    await new Promise(r => setTimeout(r, 100));

                    if (sub.target_ip_2 && sub.target_ip_2 !== sub.target_ip_1) {
                        const res = await probeIP(sub.target_ip_2);
                        results.push(makeResult(sub.id, sub.target_ip_2, res));
                    }
                }
                
                if (results.length > 0) {
                    log(`–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (${results.length}) –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏.`);
                    sender.add({ manual_region: region, results: results });
                }

                if (batchCount >= maxBatches && !stopRequested) {
                    log(`${(mode === 'express' ? '–≠–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç' : '–ü–æ–ª–Ω—ã–π —Å–∫–∞–Ω')} –∑–∞–≤–µ—Ä—à–µ–Ω.`, 'ok');
                    break;
                }

            } catch (e) {
                log(`–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–∏–∫–ª–∞: ${e.message}`, 'err');
                await new Promise(r => setTimeout(r, 5000)); 
            }
        }

        if (stopRequested) {
            log("‚èπ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.", 'warn');
        }

        toggleUI(false);
    }

    function makeResult(sid, ip, res) {
        return { subnet_id: sid, ip_tested: ip, is_accessible: res.ok, latency_ms: res.time };
    }

    async function probeIP(ip) {
        const start = Date.now();
        const timeout = 5000; 
        
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            const target = ip.includes(':') ? `https://[${ip}]` : `https://${ip}`;

            await fetch(target, { 
                mode: 'no-cors', 
                cache: 'no-store',
                signal: controller.signal 
            });
            
            clearTimeout(id);
            return { ok: true, time: Date.now() - start }; 
            
        } catch (err) {
            const time = Date.now() - start;
            if (err.name === 'AbortError') return { ok: false, time: time }; 
            return { ok: true, time: time }; 
        }
    }

    async function runSelfTest() {
        log("=== –ó–ê–ü–£–°–ö –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===", 'warn');
        
        log("1. –ü—Ä–æ–≤–µ—Ä–∫–∞ API...");
        try {
            const t1 = Date.now();
            const res = await fetch(`${API_BASE}/tasks?mode=express`);
            if (res.ok) log(`   OK! (${Date.now()-t1}–º—Å)`, 'ok');
            else log(`   –û—à–∏–±–∫–∞ HTTP ${res.status}`, 'err');
        } catch (e) {
            log(`   –ü–†–û–í–ê–õ: –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.`, 'err');
        }

        log("2. –ê–Ω–∞–ª–∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è...");
        const isNormal = await checkEnvironment();
        if (isNormal) {
             log(`   –î–æ—Å—Ç—É–ø –∫ –≤–Ω–µ—à–Ω–µ–º—É –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –ï–°–¢–¨.`, 'warn');
        } else {
             log(`   –í–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ù–ï–î–û–°–¢–£–ü–ï–ù.`, 'ok');
        }
        
        log("3. –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ (POST)...");
        try {
             const res = await fetch(`${API_BASE}/submit`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ manual_region: "TEST_DIAGNOSTIC", results: [] })
            });
            if (res.ok) log("   POST OK! –°–≤—è–∑—å —Å –±—ç–∫–µ–Ω–¥–æ–º –µ—Å—Ç—å.", 'ok');
            else log(`   POST –û–®–ò–ë–ö–ê: ${res.status}`, 'err');
        } catch(e) {
            log(`   POST –ü–†–û–í–ê–õ: ${e.message}`, 'err');
        }

        log("=== –ö–û–ù–ï–¶ ===");
    }
</script>
</body>
</html>