<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allowlist Scanner v3.2</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --border-color: #30363d;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --accent-green: #238636;
            --accent-green-hover: #2ea043;
            --accent-red: #da3633;
            --accent-blue: #1f6feb;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 800px;
            width: 100%;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        h1 span {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: normal;
        }
        .box {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h3 {
            margin-top: 0;
            font-size: 16px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            color: #fff;
        }
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        select, button {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: #21262d;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        button:hover { background: #30363d; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary { background: var(--accent-green); border-color: rgba(27,31,35,0.15); }
        .btn-primary:hover { background: var(--accent-green-hover); }
        
        .btn-danger { background: var(--accent-red); border-color: rgba(27,31,35,0.15); }
        .btn-danger:hover { background: #b62324; }
        
        .btn-debug { background: #444; color: #ddd; }
        
        .hidden { display: none !important; }

        /* Progress Bar */
        .progress-container {
            height: 10px;
            background: #21262d;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: var(--accent-blue);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            background: #0d1117;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-val { font-size: 20px; font-weight: bold; color: #fff; }
        .stat-label { font-size: 12px; color: var(--text-muted); }

        /* Logs */
        #logs {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            background: #0d1117;
            padding: 10px;
            border-radius: 4px;
            color: var(--text-muted);
        }
        .log-ok { color: #56d364; }
        .log-err { color: #f85149; }
        .log-warn { color: #e3b341; }
        .log-info { color: #58a6ff; }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>
        üì° Allowlist Scanner
        <span id="header-info" style="font-size: 14px; color: #8b949e; font-weight: normal;">
            v3.3 <span id="queue-status" style="color: #e3b341; margin-left: 10px;"></span>
        </span>
    </h1>

    <!-- Panel 1: Settings & Status -->
    <div class="box">
        <h3>üìç –ù–∞—Å—Ç—Ä–æ–π–∫–∞</h3>
        <div class="control-group">
            <select id="region-select" style="flex-grow: 1;">
                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤...</option>
            </select>
        </div>
        <div id="env-status" style="font-size: 13px; color: var(--text-muted);">
            –ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
        </div>
    </div>

    <!-- Panel 2: Controls -->
    <div class="box">
        <h3>üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <div class="control-group">
            <button id="btn-start" class="btn-primary" onclick="startScan()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <button id="btn-stop" class="btn-danger hidden" onclick="stopScan()">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <select id="concurrency-select" style="width: 140px;" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤">
                <option value="3">3 –ø–æ—Ç–æ–∫–∞</option>
                <option value="5" selected>5 –ø–æ—Ç–æ–∫–æ–≤</option>
                <option value="8">8 –ø–æ—Ç–æ–∫–æ–≤</option>
                <option value="10">10 –ø–æ—Ç–æ–∫–æ–≤</option>
            </select>
            <button class="btn-debug" onclick="runSelfTest()">üõ† Test</button>
            <button class="btn-debug" onclick="downloadReport()">üìä –û—Ç—á–µ—Ç</button>
        </div>
        
        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-val" id="stat-total">0</div>
                <div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ IP</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="stat-success" style="color: #56d364;">0</div>
                <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω–æ</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="stat-fps">0</div>
                <div class="stat-label">IP / —Å–µ–∫</div>
            </div>
        </div>
    </div>

    <!-- Logs -->
    <div class="box">
        <h3>üìù –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <div id="logs"></div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const API_BASE = '/api';
    const REGIONS = [
        {code: "RU-MOW", name: "–ú–æ—Å–∫–≤–∞"},
        {code: "RU-SPE", name: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"},
        {code: "RU-AD", name: "–ê–¥—ã–≥–µ—è"},
        {code: "RU-AL", name: "–ê–ª—Ç–∞–π (–†–µ—Å–ø—É–±–ª–∏–∫–∞)"},
        {code: "RU-ALT", name: "–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π"},
        {code: "RU-AMU", name: "–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-ARK", name: "–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-AST", name: "–ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-BA", name: "–ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω"},
        {code: "RU-BEL", name: "–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-BRY", name: "–ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-BU", name: "–ë—É—Ä—è—Ç–∏—è"},
        {code: "RU-VLA", name: "–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-VGG", name: "–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-VLG", name: "–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-VOR", name: "–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-DA", name: "–î–∞–≥–µ—Å—Ç–∞–Ω"},
        {code: "RU-JE", name: "–ï–≤—Ä–µ–π—Å–∫–∞—è –ê–û"},
        {code: "RU-ZAB", name: "–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π"},
        {code: "RU-IVA", name: "–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-IN", name: "–ò–Ω–≥—É—à–µ—Ç–∏—è"},
        {code: "RU-IRK", name: "–ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-KB", name: "–ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä–∏—è"},
        {code: "RU-KGD", name: "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-KL", name: "–ö–∞–ª–º—ã–∫–∏—è"},
        {code: "RU-KLU", name: "–ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-KAM", name: "–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π"},
        {code: "RU-KC", name: "–ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å–∏—è"},
        {code: "RU-KR", name: "–ö–∞—Ä–µ–ª–∏—è"},
        {code: "RU-KEM", name: "–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-KIR", name: "–ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-KO", name: "–ö–æ–º–∏"},
        {code: "RU-KOS", name: "–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-KDA", name: "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π"},
        {code: "RU-KYA", name: "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π"},
        {code: "RU-CRM", name: "–ö—Ä—ã–º"},
        {code: "RU-KGN", name: "–ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-KRS", name: "–ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-LEN", name: "–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-LIP", name: "–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-MAG", name: "–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-ME", name: "–ú–∞—Ä–∏–π –≠–ª"},
        {code: "RU-MO", name: "–ú–æ—Ä–¥–æ–≤–∏—è"},
        {code: "RU-MOS", name: "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-MUR", name: "–ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-NEN", name: "–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û"},
        {code: "RU-NIZ", name: "–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-NGR", name: "–ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-NVS", name: "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-OMS", name: "–û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-ORE", name: "–û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-ORL", name: "–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-PNZ", name: "–ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-PER", name: "–ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π"},
        {code: "RU-PRI", name: "–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π"},
        {code: "RU-PSK", name: "–ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-ROS", name: "–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-RYA", name: "–†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-SAM", name: "–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-SAR", name: "–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-SA", name: "–°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)"},
        {code: "RU-SAK", name: "–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-SVE", name: "–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-SEV", name: "–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å"},
        {code: "RU-SE", name: "–°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è"},
        {code: "RU-SMO", name: "–°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-STA", name: "–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π"},
        {code: "RU-TAM", name: "–¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-TA", name: "–¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω"},
        {code: "RU-TVE", name: "–¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-TOM", name: "–¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-TUL", name: "–¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-TY", name: "–¢—ã–≤–∞"},
        {code: "RU-TYU", name: "–¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-UD", name: "–£–¥–º—É—Ä—Ç–∏—è"},
        {code: "RU-ULY", name: "–£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-KHA", name: "–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π"},
        {code: "RU-KK", name: "–•–∞–∫–∞—Å–∏—è"},
        {code: "RU-KHM", name: "–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û"},
        {code: "RU-CHE", name: "–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "RU-CE", name: "–ß–µ—á–Ω—è"},
        {code: "RU-CU", name: "–ß—É–≤–∞—à–∏—è"},
        {code: "RU-CHU", name: "–ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û"},
        {code: "RU-YAM", name: "–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û"},
        {code: "RU-YAR", name: "–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"},
        {code: "OTHER", name: "–î—Ä—É–≥–æ–µ / VPN"}
    ];

    // --- STATE ---
    let state = {
        scanning: false,
        stopRequested: false,
        totalChecked: 0,
        totalSuccess: 0,
        startTime: 0,
        queue: []
    };

    // --- INIT ---
    window.onload = async () => {
        initRegions();
        log("–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ v3.2", "info");
        await detectLocation();
    };

    function initRegions() {
        const sel = document.getElementById('region-select');
        sel.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω --</option>';
        REGIONS.forEach(r => {
            sel.innerHTML += `<option value="${r.code}">${r.name}</option>`;
        });
    }

    async function detectLocation() {
        try {
            const res = await fetch('https://ipapi.co/json/');
            if (res.ok) {
                const data = await res.json();
                const regionCode = `RU-${data.region_code}`;
                const sel = document.getElementById('region-select');
                for(let i=0; i<sel.options.length; i++) {
                     if (sel.options[i].value === regionCode) {
                         sel.selectedIndex = i;
                         log(`–ê–≤—Ç–æ-–≤—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞: ${data.region}`, "ok");
                         break;
                     }
                }
            }
        } catch (e) {}
    }

    // --- LOGGING ---
    function log(msg, type='def') {
        const el = document.getElementById('logs');
        const time = new Date().toLocaleTimeString();
        el.innerHTML += `<div class="log-${type}">[${time}] ${msg}</div>`;
        el.scrollTop = el.scrollHeight;
    }

    // --- CHECK ENVIRONMENT (Google vs Yandex) ---
    async function checkEnvironment(silent = false) {
        if (!silent) log("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ '–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫'...", 'warn');
        const TIMEOUT = 5000;
        const ruTarget = 'https://ya.ru/favicon.ico';
        const globalTarget = 'https://www.google.com/favicon.ico';

        const check = (url) => new Promise(resolve => {
            const img = new Image();
            const start = Date.now();
            let done = false;
            const src = url + ((url.includes('?') ? '&' : '?') + 't=' + Date.now());
            
            const finish = (ok) => {
                if(done) return;
                done = true;
                resolve({ ok: ok, time: Date.now() - start });
            };
            img.onload = () => finish(true);
            img.onerror = () => finish(false);
            setTimeout(() => finish(false), TIMEOUT);
            img.src = src;
        });

        // 1. RU
        const ru = await check(ruTarget);
        if (!ru.ok) {
            if (!silent) log("   ‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ø–Ω–¥–µ–∫—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞?", 'err');
            return false; // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—É—Å–∫ (–Ω–∞ —É–¥–∞—á—É)
        }
        if (!silent) log(`   ‚úÖ RU –¥–æ—Å—Ç—É–ø–µ–Ω (${ru.time}ms)`, 'ok');

        // 2. Global
        const world = await check(globalTarget);
        if (world.ok) {
            log(`   üåç Google –¥–æ—Å—Ç—É–ø–µ–Ω (${world.time}ms).`, 'ok');
            if (!silent) log("   üöÄ –û–±–Ω–∞—Ä—É–∂–µ–Ω –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –û–¢–ú–ï–ù–ï–ù–û.", 'warn');
            return true; // IS_NORMAL = true -> STOP
        } else {
            if (!silent) {
                log("   ‚õîÔ∏è Google –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!", 'err');
                log("   üïµÔ∏è‚Äç‚ôÇÔ∏è –ü–æ—Ö–æ–∂–µ, –≤–∫–ª—é—á–µ–Ω '–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫'. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω...", 'ok');
            }
            return false; // IS_NORMAL = false -> START
        }
    }

    // --- CORE SCAN LOGIC (PARALLEL) ---
    async function startScan() {
        const region = document.getElementById('region-select').value;
        if (!region) { alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω!"); return; }
        
        state.scanning = true;
        state.stopRequested = false;
        state.totalChecked = 0;
        state.totalSuccess = 0;
        state.startTime = Date.now();
        
        updateUI(true);

        log("üöÄ –°–¢–ê–†–¢ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...", "ok");

        // Main Loop
        while (!state.stopRequested) {
            try {
                // CHECK ENVIRONMENT (Inside loop per user request)
                // Silent check to avoid log spam, but stop if Google becomes available
                const isNormal = await checkEnvironment(true);
                if (isNormal) {
                    log("   üåç Google –¥–æ—Å—Ç—É–ø–µ–Ω. –ñ–¥–µ–º –≤–∫–ª—é—á–µ–Ω–∏—è –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞...", 'warn');
                    await sleep(5000);
                    continue;
                }

                log("–ó–∞–ø—Ä–æ—Å –∑–∞–¥–∞—á...", "info");
                const res = await fetch(`${API_BASE}/tasks?mode=full&min_priority=1`);
                if (!res.ok) throw new Error("API Error");
                const tasks = await res.json();
                
                if (!tasks || tasks.length === 0) {
                    log("–ù–µ—Ç –∑–∞–¥–∞—á. –ñ–¥–µ–º 5 —Å–µ–∫...", "warn");
                    await sleep(5000);
                    continue;
                }

                // Prepare Queue
                let ipQueue = [];
                tasks.forEach(t => {
                    if(t.target_ip_1) ipQueue.push({sid: t.id, ip: t.target_ip_1});
                    if(t.target_ip_2) ipQueue.push({sid: t.id, ip: t.target_ip_2});
                });

                log(`–ü–∞–∫–µ—Ç: ${ipQueue.length} IP. –û–±—Ä–∞–±–æ—Ç–∫–∞...`, "info");
                
                // PARALLEL PROCESSING
                const concurrency = parseInt(document.getElementById('concurrency-select').value) || 5;
                const results = await processQueue(ipQueue, concurrency);
                
                // Submit Results
                if (results.length > 0) {
                    await submitResults(region, results);
                }

            } catch (e) {
                log(`–û—à–∏–±–∫–∞: ${e.message}`, "err");
                await sleep(3000);
            }
        }
        
        updateUI(false);
        log("‚èπ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.", "warn");
    }

    function stopScan() {
        state.stopRequested = true;
        log("–ó–∞–ø—Ä–æ—Å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...", "warn");
    }

    async function processQueue(queue, limit) {
        if (queue.length === 0) return []; // Fix: prevent hang on empty queue
        let results = [];
        let index = 0;
        let active = 0;
        const total = queue.length;
        
        return new Promise((resolve) => {
            const next = async () => {
                if (state.stopRequested) {
                    if (active === 0) resolve(results);
                    return;
                }
                
                if (index >= queue.length) {
                    if (active === 0) resolve(results);
                    return;
                }

                // Worker Task
                const item = queue[index++];
                active++;
                
                // UI update
                const pct = Math.round((index / total) * 100);
                document.getElementById('progress-bar').style.width = `${pct}%`;

                try {
                    const res = await probeIP(item.ip);
                    results.push({
                        subnet_id: item.sid,
                        ip_tested: item.ip,
                        is_accessible: res.ok,
                        latency_ms: res.time
                    });
                    
                    state.totalChecked++;
                    if(res.ok) state.totalSuccess++;
                    updateStatsDisplay();

                } catch (e) {
                } finally {
                    active--;
                    next(); // Recursive chain
                }
            };

            // Initial Fan-Out
            const initialWorkers = Math.min(limit, queue.length);
            for (let i = 0; i < initialWorkers; i++) {
                next();
            }
        });
    }

    async function probeIP(ip) {
        const start = Date.now();
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        try {
            const target = ip.includes(':') ? `https://[${ip}]` : `https://${ip}`;
            await fetch(target, { 
                mode: 'no-cors', 
                cache: 'no-store',
                signal: controller.signal 
            });
            clearTimeout(timeoutId);
            return { ok: true, time: Date.now() - start };
        } catch (err) {
            clearTimeout(timeoutId);
            const time = Date.now() - start;
            if (err.name === 'AbortError') return { ok: false, time: time };
            return { ok: true, time: time };
        }
    }

    // --- –ö–õ–ê–°–° –û–¢–ü–†–ê–í–ö–ò –†–ï–ó–£–õ–¨–¢–ê–¢–û–í (–û—á–µ—Ä–µ–¥—å + Retry) ---
    class ResultSender {
        constructor() {
            this.queue = [];
            this.isSending = false;
            this.retryLimit = 10; 
        }

        add(data) {
            this.queue.push({ data: data, attempts: 0 });
            this.updateStatus();
            this.process();
        }

        updateStatus() {
            const el = document.getElementById('queue-status');
            if (this.queue.length > 0) {
                el.innerText = `[–û—á–µ—Ä–µ–¥—å: ${this.queue.length}]`;
            } else {
                el.innerText = "";
            }
        }

        async process() {
            if (this.isSending || this.queue.length === 0) return;
            this.isSending = true;

            const item = this.queue[0];
            // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1—Å, 1.5—Å, 2.25—Å ... –¥–æ 30—Å
            const delay = Math.min(1000 * Math.pow(1.5, item.attempts), 30000); 

            try {
                if (item.attempts > 0) {
                    await new Promise(r => setTimeout(r, delay));
                    log(`üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ (–ø–æ–ø—ã—Ç–∫–∞ ${item.attempts + 1})...`, 'warn');
                }

                const response = await fetch(`${API_BASE}/submit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item.data)
                });

                if (!response.ok) {
                    // –ï—Å–ª–∏ 4xx –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 400 Bad Request), –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –≤–µ—á–Ω–æ
                    if (response.status >= 400 && response.status < 500) {
                         throw new Error(`Fatal HTTP ${response.status}`);
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                log(`‚úÖ –ü–∞–∫–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.`, 'ok');
                this.queue.shift(); // –£–¥–∞–ª—è–µ–º —É—Å–ø–µ—à–Ω—ã–π
                // loadGlobalStats(); // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É

            } catch (e) {
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Ñ–∞—Ç–∞–ª—å–Ω–∞—è (4xx) - –¥—Ä–æ–ø–∞–µ–º
                if (e.message.includes('Fatal')) {
                    log(`üíÄ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (${e.message}). –î–∞–Ω–Ω—ã–µ –æ—Ç–±—Ä–æ—à–µ–Ω—ã.`, 'err');
                    this.queue.shift();
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${e.message}. –ü–æ–≤—Ç–æ—Ä...`, 'warn');
                    item.attempts++;
                    if (item.attempts >= this.retryLimit) {
                        log(`üíÄ –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞–∫–µ—Ç –ø–æ—Å–ª–µ ${this.retryLimit} –ø–æ–ø—ã—Ç–æ–∫. –î–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã.`, 'err');
                        this.queue.shift();
                    }
                }
            } finally {
                this.isSending = false;
                this.updateStatus();
                if (this.queue.length > 0) this.process();
            }
        }
    }
    
    const sender = new ResultSender();

    async function submitResults(region, results) {
        // –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å, –∫–ª–∞—Å—Å —Å–∞–º —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è
        sender.add({
            manual_region: region,
            results: results
        });
        log(`üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (${results.length}) –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏.`, "info");
    }

    function updateUI(scanning) {
        document.getElementById('btn-start').classList.toggle('hidden', scanning);
        document.getElementById('btn-stop').classList.toggle('hidden', !scanning);
        document.getElementById('progress-container').style.display = scanning ? 'block' : 'none';
        document.getElementById('region-select').disabled = scanning;
        document.getElementById('concurrency-select').disabled = scanning;
    }

    function updateStatsDisplay() {
        document.getElementById('stat-total').innerText = state.totalChecked;
        document.getElementById('stat-success').innerText = state.totalSuccess;
        const duration = (Date.now() - state.startTime) / 1000;
        const fps = duration > 0 ? (state.totalChecked / duration).toFixed(1) : 0;
        document.getElementById('stat-fps').innerText = fps;
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    
    async function downloadReport() {
        const mirrorId = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –Ω–æ–¥—ã (Mirror ID) –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:");
        if (!mirrorId) return;
        
        const url = `${API_BASE}/report/csv?mirror_id=${encodeURIComponent(mirrorId)}`;
        window.open(url, '_blank');
        log("–ó–∞–ø—Ä–æ—Å –æ—Ç—á–µ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω...", "info");
    }
    
    async function runSelfTest() {
        log("=== –ó–ê–ü–£–°–ö –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===", 'warn');
        log("1. –ü—Ä–æ–≤–µ—Ä–∫–∞ API (GET)...");
        try {
            const t1 = Date.now();
            const res = await fetch(`${API_BASE}/tasks?mode=express`);
            if (res.ok) log(`   ‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω (${Date.now()-t1}–º—Å)`, 'ok');
            else log(`   ‚ùå –û—à–∏–±–∫–∞ API: HTTP ${res.status}`, 'err');
        } catch (e) {
            log(`   ‚ùå –ü–†–û–í–ê–õ: –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (Network Error).`, 'err');
        }

        log("2. –ê–Ω–∞–ª–∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è...");
        const isNormal = await checkEnvironment(); 
        
        log("3. –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö (POST)...");
        try {
             const res = await fetch(`${API_BASE}/submit`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ manual_region: "TEST_DIAGNOSTIC", results: [] })
            });
            
            if (res.ok) log("   ‚úÖ –ë—ç–∫–µ–Ω–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ (POST OK).", 'ok');
            else log(`   ‚ùå –ë—ç–∫–µ–Ω–¥ –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${res.status}`, 'err');
        } catch(e) {
            log(`   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${e.message}`, 'err');
        }
        log("=== –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===");
    }

</script>
</body>
</html>